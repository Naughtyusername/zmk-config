* TODO Tasks

** [ ] Finalize QMK wrapper porting
   - [ ] Review and update comments in `config/wrappers.dtsi` to be ZMK-specific.
   - [ ] Implement `ADJUST` layer functionality.
   - [ ] Adapt the `BLANK_TEMPLATE` to ZMK conventions.

** [ ] Define thumb key layouts
   - [ ] Populate `___SWEEP_THUMBS_...___` macros for cradio/sweep keyboard.
   - [ ] Populate `___SOFLE_THUMBS_...___` macros for sofle keyboard.

** [ ] Map All Physical Keys on Sofle Keymap (60 keys) - HIGH PRIORITY
   - **The Discrepancy:** Your `sofle.keymap` currently explicitly binds 46 key positions, but your Sofle has a 60-key physical matrix (as per `sofle.h`). The remaining 14 keys are implicitly `&none`.
   - **Goal:** Explicitly map all 60 physical key positions in `config/sofle.keymap` to have full control over your layout.
   - **Your Desired Layout:**
     - Row 1 (physical top row): Number Row (1-0)
     - Row 2 (physical next row): Top row (QWERTY)
     - Row 3 (physical home row): Home row (ASDFG)
     - Row 4 (physical bottom row): Bottom row (ZXCVB)
     - Row 5 (physical thumb cluster): Thumb row
   - **Action Steps:**
     - **Review `sofle.h`:** Understand the matrix positions (0-59) for each physical key.
     - **Update `config/wrappers.dtsi`:** Create/adjust macros (e.g., `___BASE_L1___`, `___BASE_R1___`, etc.) to match your desired layout (e.g., first row macros output `&kp N1 &kp N2 ...`). You may need new macros for the physical bottom row.
     - **Update `config/sofle.keymap`:** Ensure the `bindings` array for each layer in your `sofle.keymap` explicitly lists 60 key entries using your wrapper macros or direct bindings.
       - Include bindings for the physical bottom row (e.g., `LB0-LB5`, `RB0-RB5`).
       - Include bindings for the encoder push buttons (`LEC` at 42, `REC` at 43). Assign `&none` to unused positions.
     - **Verify:** After changes, the `bindings` array should have exactly 60 entries.

** [ ] Port Missing QMK Features
   - [ ] **Per-Key Tapping Term:** Your QMK config uses a longer tapping term for weaker pinky fingers.
     - To port this, create new `hold-tap` behaviors in `config/behaviors.dtsi` (e.g., `hml_pinky`) with a longer `tapping-term-ms` (e.g., 185).
     - Apply this new behavior to the pinky home-row keys (`A`, `;`) in `config/wrappers.dtsi`.
   - [ ] **One-Shot Mods on Thumbs:** Your QMK thumb clusters use One-Shot Mods extensively. This is a major ergonomic feature to port.
     - In `config/wrappers.dtsi`, edit the `___SWEEP_THUMBS...___` and `___SOFLE_THUMBS...___` macros.
     - Replace `&none` with the ZMK equivalent of `OSM()`, which is `&sk`. For example, `&sk LALT` for one-shot Alt.
   - [X] **"J + K" Combo for Escape:** Your QMK config uses `J+K` for `Escape` (Vim style). (COMPLETED - implemented using an overriding pattern for both boards)
     - The generic combo is defined in `config/combos.dtsi`.
     - Sofle-specific key positions (`<31 32>`) are set in `config/sofle.keymap`.
     - Cradio-specific key positions (`<16 17>`) are set in `config/cradio.keymap`.
   - [ ] **Advanced Home Row Mod Tuning:** Your QMK config uses `PERMISSIVE_HOLD`, `SPECULATIVE_HOLD`, and `FLOW_TAP_TERM` for a very specific feel. A direct 1:1 port is not possible, but you can approximate it.
     - In `config/behaviors.dtsi`, experiment with the properties of your `hold-tap` behaviors.
     - `flavor = "balanced";` is a good starting point (already implemented).
     - `require-prior-idle-ms = <X>;` (e.g., 100) can be a substitute for `FLOW_TAP_TERM`, preventing accidental holds during fast typing rolls. This will require trial and error to get the feel right.

** [ ] Define encoder behavior
   - [ ] Investigate migrating from `&inc_dec_kp` to the more flexible `&sensor_rotate` behavior.
   - [ ] Customize encoder behavior for each layer.

** [ ] Implement advanced layer management
   - [ ] **Sticky Layers (&sk):** Configure sticky layers for momentary layer access.
   - [X] Conditional/Tri-Layers: Set up a "tri-layer" that activates when both `LOWER` and `RAISE` layers are active. (COMPLETED by Gemini CLI)
   - [ ] **Long-press for ADJUST layer:**
     - [ ] Create a `hold-tap` behavior for 'Z' with a 2-second hold to activate `&mo ADJUST`.
     - [ ] Create a `hold-tap` behavior for '/' with a 2-second hold to activate `&mo ADJUST`.

** [ ] Add new combos and tap-dances
   - [ ] **Macros for Auto-Pairing (add these to `config/behaviors.dtsi`):**
     - `macro_parens`: Sends `()` and moves cursor left.
       #+begin_src dts
       macro_parens: auto_parens {
           compatible = "zmk,behavior-macro";
           #binding-cells = <0>;
           bindings = <&kp LPAR &kp RPAR &kp LEFT>;
       };
       #+end_src
     - `macro_curly_braces`: Sends `{}` and moves cursor left.
       #+begin_src dts
       macro_curly_braces: auto_curly_braces {
           compatible = "zmk,behavior-macro";
           #binding-cells = <0>;
           bindings = <&kp LBRC &kp RBRC &kp LEFT>;
       };
       #+end_src
     - `macro_square_brackets`: Sends `[]` and moves cursor left.
       #+begin_src dts
       macro_square_brackets: auto_square_brackets {
           compatible = "zmk,behavior-macro";
           #binding-cells = <0>;
           bindings = <&kp LBKT &kp RBKT &kp LEFT>;
       };
       #+end_src
   - [ ] **Combos (QMK's "Chordal"):**
     - [ ] `Q`+`W` for `Esc`.
     - [ ] `J`+`K` for `Escape` (from QMK config).
     - [ ] `S`+`D` for `Tab` (especially for Sweep).
     - [X] **`A + S` → `Backspace`** (COMPLETED - implemented using an overriding pattern for both boards)
       - The generic combo is defined in `config/combos.dtsi`.
       - Sofle-specific key positions (`<25 26>`) are set in `config/sofle.keymap`.
       - Cradio-specific key positions (`<11 12>`) are set in `config/cradio.keymap`.
     - [X] **`L + ;` → `Enter`** (COMPLETED - implemented using an overriding pattern for both boards)
       - The generic combo is defined in `config/combos.dtsi`.
       - Sofle-specific key positions (`<33 34>`) are set in `config/sofle.keymap`.
       - Cradio-specific key positions (`<18 19>`) are set in `config/cradio.keymap`.
     - [X] **`F + G` → `_` (Underscore)** (COMPLETED - implemented using an overriding pattern for both boards)
       - The generic combo is defined in `config/combos.dtsi`.
       - Sofle-specific key positions (`<28 29>`) are set in `config/sofle.keymap`.
       - Cradio-specific key positions (`<13 14>`) are set in `config/cradio.keymap`.
     - [ ] **`U + I` → `()` (using macro_parens)**
       #+begin_src dts
       combo_ui_parens {
           timeout-ms = <50>;
           key-positions = <P7 P8>; // Replace P7 P8 with actual key positions for U and I
           bindings = <&macro_parens>;
           layers = <BASE>;
       };
       #+end_src
     - [ ] **`Y + U` → `{}` (using macro_curly_braces)**
       #+begin_src dts
       combo_yu_curly_braces {
           timeout-ms = <50>;
           key-positions = <P9 P10>; // Replace P9 P10 with actual key positions for Y and U
           bindings = <&macro_curly_braces>;
           layers = <BASE>;
       };
       #+end_src
     - [ ] **`I + O` → `[]` (using macro_square_brackets)**
       #+begin_src dts
       combo_io_square_brackets {
           timeout-ms = <50>;
           key-positions = <P11 P12>; // Replace P11 P12 with actual key positions for I and O
           bindings = <&macro_square_brackets>;
           layers = <BASE>;
       };
       #+end_src
     - [ ] **Left Thumb `T1 + T2` → `ADJUST` Layer**
       #+begin_src dts
       combo_left_thumbs_adjust {
           timeout-ms = <50>;
           key-positions = <LEFT_THUMB_POS1 LEFT_THUMB_POS2>; // Replace with actual key positions for left thumb keys
           bindings = <&mo ADJUST>;
           layers = <BASE>;
       };
       #+end_src
     - [ ] **`Z + /` → `FUNCTION` Layer**
       #+begin_src dts
       combo_z_fslash_func {
           timeout-ms = <50>;
           key-positions = <Z_KEY_POS FSLASH_KEY_POS>; // Replace with actual key positions for Z and /
           bindings = <&mo FUNCTION>;
           layers = <BASE>;
       };
       #+end_src
     - [ ] Home row combos for cut/copy/paste.
     - [ ] **Combo for Timed One-Shot Layer (for Sweep):** Create a combo to activate a layer for one keypress, which also times out after a set duration. This is great for quick access to a layer without a dedicated key.
       - In your keymap file (e.g., `cradio.keymap`), first define a reusable sticky layer behavior with a custom timeout:
       #+begin_src dts
       / {
           behaviors {
               timed_osl: timed_one_shot_layer {
                   compatible = "zmk,behavior-sticky-layer";
                   #binding-cells = <1>;
                   bindings = <&mo>;
                   release-after-ms = <2000>; // Stays active for 2s
               };
           };
       #+end_src
       - Then, create a combo that uses this behavior to activate a specific layer (e.g., `LOWER`):
       #+begin_src dts
           combos {
               compatible = "zmk,combos";
               combo_osl_lower {
                   timeout-ms = <50>;
                   key-positions = <P1 P2>; // Replace with key positions, e.g., outer bottom row keys
                   bindings = <&timed_osl LOWER>;
                   layers = <BASE>;
               };
           };
       };
       #+end_src
   - [ ] **Tap-Dances:**
     - [ ] A key for brackets: `(` on tap, `[` on double-tap, `{` on hold.
     - [ ] A key for navigation: `Up` on tap, `Page Up` on double-tap.

** [ ] Implement Advanced Key Behaviors
   - [ ] **Fix `CAPS_WORD` interaction with Tap Dance keys (`TD_Q_ESC`)**
     - **The Problem:** `CAPS_WORD` only capitalizes basic key presses. It does not see the `Q` being sent from a complex tap-dance behavior in either QMK or ZMK.
     -
     - **QMK Fix:** Convert the simple tap-dance to an advanced one with a handler function that manually checks if `CAPS_WORD` is active.
       - 1. In `keyrecords.c`, change the `tap_dance_actions` definition:
         #+begin_src c
         // Forward-declare the handler function
         void q_esc_dance_finished(qk_tap_dance_state_t *state, void *user_data);

         tap_dance_action_t tap_dance_actions[] = {
             [TD_Q_ESC] = ACTION_TAP_DANCE_FN(q_esc_dance_finished),
         };
         #+end_src
       - 2. In `naughtyusername.c`, add the handler function itself:
         #+begin_src c
         #include "features/caps_word.h" // Add this at the top

         void q_esc_dance_finished(qk_tap_dance_state_t *state, void *user_data) {
           if (state->count == 1) { // Single tap
             if (caps_word_is_active()) {
               register_code(KC_LSFT);
               register_code(KC_Q);
               unregister_code(KC_Q);
               unregister_code(KC_LSFT);
             } else {
               register_code(KC_Q);
               unregister_code(KC_Q);
             }
           } else { // Double tap
             register_code(KC_ESC);
             unregister_code(KC_ESC);
           }
         }
         #+end_src
     -
     - **ZMK Fix (Workaround):** A direct fix requires writing custom C code. The pragmatic workaround is to use a `hold-tap` behavior, where tapping gives you the character (which `&caps_word` can see) and holding gives you the function.
       - 1. In `config/behaviors.dtsi`, define a new `hold-tap` behavior:
         #+begin_src dts
         q_esc_ht: q_escape_hold_tap {
             compatible = "zmk,behavior-hold-tap";
             label = "Q_ESC_HT";
             #binding-cells = <0>;
             tapping-term-ms = <220>; // A little longer for a primary key
             flavor = "tap-preferred";
             bindings = <&kp Q>, <&kp ESC>;
         };
         #+end_src
       - 2. In `config/wrappers.dtsi`, update the `___BASE_L1___` macro to use the new behavior instead of `&td_q_esc`:
         #+begin_src c
         #define ___BASE_L1___ &q_esc_ht ...
         #+end_src
   - [ ] **Smart Key Repeat:** Add key repeat to home-row mods. This allows a letter to repeat on a double-tap-and-hold, which is not possible with a standard hold-tap.
     - Add this behavior to `config/behaviors.dtsi`:
       #+begin_src dts
       hml_rep: homerow_mods_left_with_repeat {
           compatible = "zmk,behavior-hold-tap";
           label = "HML_REPEAT";
           #binding-cells = <2>;
           tapping-term-ms = <200>;
           flavor = "balanced";
           bindings = <&kp>, <&kp>;
           hold-bindings = <&kp>, <&key_repeat>;
       };
       #+end_src
     - Update home-row mod macros in `config/wrappers.dtsi` to use the new behavior (e.g., `&hml_rep`).

** [X] Configure Sofle Hardware (Battery, Output, Layer Status widgets enabled)
   - [X] **Add status widgets to OLED:** The `sofle.conf` file now enables Battery Status, Output Status, and Layer Status widgets for the central side. (COMPLETED by Gemini CLI after resolving build issues)
     - `CONFIG_ZMK_WIDGET_BATTERY_STATUS=y`
     - `CONFIG_ZMK_WIDGET_BATTERY_STATUS_SHOW_PERCENTAGE=y`
     - `CONFIG_ZMK_WIDGET_OUTPUT_STATUS=y`
     - `CONFIG_ZMK_WIDGET_LAYER_STATUS=y`
   - [ ] **Add WPM widget to OLED:** `CONFIG_ZMK_WPM=y` and `CONFIG_ZMK_WIDGET_WPM_STATUS=y` were removed to resolve peripheral build issues. To properly enable WPM on the central side, you would need to create `sofle_left.conf` (for central-specific configs) and `sofle_right.conf` (for peripheral-specific configs) and place these flags in `sofle_left.conf`.
   - [ ] Add RGB underglow support to indicate the current layer.

** [ ] Integrate external modules
   - [ ] **`zmk-tri-state`:**
     - [ ] Add the module to `west.yml`.
     - [ ] Implement a one-handed Alt-Tab "swapper" (Swapper).
     - [ ] Use it to create the `ADJUST` tri-layer.
   - [ ] **`zmk-antecedent-morph`:**
     - [ ] Find and add `urob`'s module to `west.yml`.
     - [ ] Implement adaptive behaviors for common programming ligatures like `=>`, `!=`, `->`.

** [ ] Explore advanced ZMK behaviors (QMK Equivalents)
    - [ ] **`CAPS WORD` Configuration:**
      - 1. Add `CONFIG_ZMK_CAPS_WORD=y` to your `.conf` file.
      - 2. Add `&caps_word` to a key in your keymap (e.g., in a combo).
      - 3. **Customize Behavior (Recommended for Programming):** For fine-grained control, define a custom `caps_word` behavior in `config/behaviors.dtsi`.
         - **`continue-list`:** This is the most important property. It lets you define which keys *don't* break the `CAPS_WORD` state. The default is `A-Z`, `0-9`, `UNDERSCORE`, `BSPC`, `DEL`. You can add to it.
         #+begin_src dts
         // Example of a custom caps_word behavior in config/behaviors.dtsi
         my_caps_word: my_caps_word_behavior {
             compatible = "zmk,behavior-caps-word";
             #binding-cells = <0>;
             // Example: Add MINUS to the list of keys that don't break CAPS_WORD
             continue-list = <UNDERSCORE MINUS BSPC DEL>;
         };
         #+end_src
         - **`mods`:** You can also change the modifier from `Shift` to something else, for example `mods = <(MOD_LCTL | MOD_LALT)>;`.
         - Remember to use your custom behavior in your keymap (e.g., `&my_caps_word`) instead of the default `&caps_word`.
    - [ ] **Dynamic Macros:** Investigate and enable `CONFIG_ZMK_MACRO_DYNAMIC=y` for on-the-fly macro recording.
    - [ ] **Speculative Hold:** Use the `hold-while-undecided` property in hold-tap behaviors to reduce modifier lag.
    - [ ] **Permissive Hold:** Use the `"balanced"` flavor for hold-tap behaviors for a more responsive feel for fast typists.
    - [ ] **Per-key Tapping Term:** Use the `tapping-term-ms` property on specific hold-tap bindings that need a custom value.
    - [ ] **Numword (Smart Layers):** Implement behavior where the layer stays active only while typing numbers, deactivating on space/letter.
    - [ ] **Mod-Morphs (Contextual Keys):** Expand usage beyond `bs_del`, e.g., smart dot ('.', '..', '/'), grave escape ('Esc' to '`' when GUI is held).

** [ ] Configure BIOS/Bootloader Compatibility (NKRO)
   - [ ] NOTE: ZMK defaults to 6KRO, which is safe for BIOS. Enabling NKRO (`CONFIG_ZMK_HID_REPORT_TYPE_NKRO=y`) improves OS performance but may break BIOS compatibility.
   - [ ] NOTE: Unlike QMK, there is no runtime keybinding to toggle between 6KRO and NKRO. The mode is set at compile time. QMK's `NK_TOGG` keycode is not directly portable.
   - [ ] DECISION: Decide whether to enable NKRO by default and test for BIOS compatibility.
   - [ ] ACTION: Add `CONFIG_ZMK_HID_REPORT_TYPE_NKRO=y` to the `.conf` files if NKRO is desired.

** [ ] Merge `wrappertest` branch

** [ ] ZMK Studio Integration
   - [ ] Add the ZMK Studio snippet to `build_all.sh`.
   - [ ] Configure a `&studio_unlock` key in the keymap for real-time keymap changes.

** [ ] Implement Special Use Layers (Lower Priority)
   - [ ] **Design and Implement Roguelike Gaming Layer (`ROGUELIKE`)**
     - Goal: Create a dedicated layer optimized for roguelike games, likely featuring a numpad-like layout and common game commands.
     - Reference: Use your existing QMK `gaming2_layer` from `tmp/qmk_userspace/users/naughtyusername/naughtyusername.c` as the primary inspiration and starting point for bindings.
     - Action: Define a new layer (e.g., `ROGUELIKE` or `NON_VIM_GAMING`) in `config/wrappers.dtsi` and populate its bindings in your keymap files.

* Kconfig Reference
  A reference of common Kconfig options to add to your `.conf` files.

*** General
    - `CONFIG_ZMK_KEYBOARD_NAME`: Sets the name your keyboard advertises.
    - `CONFIG_ZMK_WPM`: Enables words-per-minute calculation.

*** Behavior
    - `CONFIG_ZMK_COMBOS`: Enables combos.
    - `CONFIG_ZMK_MACROS`: Enables macros.
    - `CONFIG_ZMK_TAP_DANCE`: Enables tap-dance behaviors.
    - `CONFIG_ZMK_STICKY_KEYS`: Enables sticky keys/layers (`&sk`).
    - `CONFIG_ZMK_HOLD_TAP`: Enables hold-tap behaviors.
    - `CONFIG_ZMK_HOLD_TAP_INTERRUPTIBLE`: Makes hold-taps interruptible.

*** Hardware & Features
    - `CONFIG_BT`: Enables Bluetooth.
    - `CONFIG_BT_MAX_PAIRED`: Sets the max number of paired Bluetooth devices.
    - `CONFIG_USB_DEVICE_PRODUCT`: Sets the product name for USB.
    - `CONFIG_ZMK_USB_BOOT`: Enables a more compatible USB mode for BIOS/UEFI.
    - `CONFIG_ZMK_DISPLAY`: Enables support for OLED/LCD screens.
    - `CONFIG_ZMK_RGB_UNDERGLOW`: Enables RGB underglow.
    - `CONFIG_ZMK_BACKLIGHT`: Enables single-color backlighting.
    - `CONFIG_EC11`: Enables support for EC11-style rotary encoders.
