* TODO Tasks

** [ ] Finalize QMK wrapper porting
   - [ ] Review and update comments in `config/wrappers.dtsi` to be ZMK-specific.
   - [X] Implement `ADJUST` layer functionality.
   - [X] Adapt the `BLANK_TEMPLATE` to ZMK conventions.
     we did this by just aliasing ______ to trans

** [ ] Define thumb key layouts
   - [X] Populate `___SWEEP_THUMBS_...___` macros for cradio/sweep keyboard.
     mostly got these done, i just really dont know what the fuck to put on the sofle
     sweep we could finess some extra on some layers too.
   - [ ] Populate `___SOFLE_THUMBS_...___` macros for sofle keyboard.

** [ ] Port Missing QMK Features
   - [ ] **Per-Key Tapping Term:** Your QMK config uses a longer tapping term for weaker pinky fingers.
     - To port this, create new `hold-tap` behaviors in `config/behaviors.dtsi` (e.g., `hml_pinky`) with a longer `tapping-term-ms` (e.g., 185).
     - Apply this new behavior to the pinky home-row keys (`A`, `;`) in `config/wrappers.dtsi`.
   - [ ] **One-Shot Mods on Thumbs:** Your QMK thumb clusters use One-Shot Mods extensively. This is a major ergonomic feature to port.
     - In `config/wrappers.dtsi`, edit the `___SWEEP_THUMBS...___` and `___SOFLE_THUMBS...___` macros.
     - Replace `&none` with the ZMK equivalent of `OSM()`, which is `&sk`. For example, `&sk LALT` for one-shot Alt.
   - [X] **"J + K" Combo for Escape:** Your QMK config uses `J+K` for `Escape` (Vim style).
     - Add a combo definition to your keymap files (e.g., `cradio.keymap` or `sofle.keymap`) to implement this.
     - Note: The existing todo list has `J+K` for `Enter`. Decide which one to implement.
   - [ ] **Advanced Home Row Mod Tuning:** Your QMK config uses `PERMISSIVE_HOLD`, `SPECULATIVE_HOLD`, and `FLOW_TAP_TERM` for a very specific feel. A direct 1:1 port is not possible, but you can approximate it.
     - In `config/behaviors.dtsi`, experiment with the properties of your `hold-tap` behaviors.
     - `flavor = "balanced";` is a good starting point (already implemented).
     - `require-prior-idle-ms = <X>;` (e.g., 100) can be a substitute for `FLOW_TAP_TERM`, preventing accidental holds during fast typing rolls. This will require trial and error to get the feel right.

** [X] Define encoder behavior (Migrated to flexible sensor_rot_kp)
   - [X] Investigate migrating from `&inc_dec_kp` to the more flexible `&sensor_rotate` behavior. (COMPLETED - implemented `sensor_rot_kp` behavior in `config/behaviors.dtsi` and updated wrapper macros in `config/wrappers.dtsi`)
   - [X] Customize encoder behavior for each layer. (COMPLETED - now possible by overriding `sensor-bindings` in keymap layers using `&sensor_rot_kp`)

** [ ] Implement advanced layer management
   - [ ] **Sticky Layers (&sk):** Configure sticky layers for momentary layer access.
   - [X] Conditional/Tri-Layers: Set up a "tri-layer" that activates when both `LOWER` and `RAISE` layers are active. (COMPLETED by Gemini CLI)
   - [ ] **Long-press for ADJUST layer:**
     - [ ] Create a `hold-tap` behavior for 'Z' with a 2-second hold to activate `&mo ADJUST`.
     - [ ] Create a `hold-tap` behavior for '/' with a 2-second hold to activate `&mo ADJUST`.

** [ ] Add new combos and tap-dances
   - [X] **Combos (QMK's "Chordal"):**
     - [X] `Q`+`W` for `Esc`.
     - [X] `J`+`K` for `Escape` (from QMK config).
     - [X] `S`+`D` for `Tab`.

** [ ] Implement Advanced Key Behaviors
   - [ ] **Fix `CAPS_WORD` interaction with Tap Dance keys (`TD_Q_ESC`)**
     - **The Problem:** `CAPS_WORD` only capitalizes basic key presses. It does not see the `Q` being sent from a complex tap-dance behavior in either QMK or ZMK.
     -
     - **QMK Fix:** Convert the simple tap-dance to an advanced one with a handler function that manually checks if `CAPS_WORD` is active.
       - 1. In `keyrecords.c`, change the `tap_dance_actions` definition:
         #+begin_src c
         // Forward-declare the handler function
         void q_esc_dance_finished(qk_tap_dance_state_t *state, void *user_data);

         tap_dance_action_t tap_dance_actions[] = {
             [TD_Q_ESC] = ACTION_TAP_DANCE_FN(q_esc_dance_finished),
         };
         #+end_src
       - 2. In `naughtyusername.c`, add the handler function itself:
         #+begin_src c
         #include "features/caps_word.h" // Add this at the top

         void q_esc_dance_finished(qk_tap_dance_state_t *state, void *user_data) {
           if (state->count == 1) { // Single tap
             if (caps_word_is_active()) {
               register_code(KC_LSFT);
               register_code(KC_Q);
               unregister_code(KC_Q);
               unregister_code(KC_LSFT);
             } else {
               register_code(KC_Q);
               unregister_code(KC_Q);
             }
           } else { // Double tap
             register_code(KC_ESC);
             unregister_code(KC_ESC);
           }
         }
         #+end_src
     -
     - **ZMK Fix (Workaround):** A direct fix requires writing custom C code. The pragmatic workaround is to use a `hold-tap` behavior, where tapping gives you the character (which `&caps_word` can see) and holding gives you the function.
       - 1. In `config/behaviors.dtsi`, define a new `hold-tap` behavior:
         #+begin_src dts
         q_esc_ht: q_escape_hold_tap {
             compatible = "zmk,behavior-hold-tap";
             label = "Q_ESC_HT";
             #binding-cells = <0>;
             tapping-term-ms = <220>; // A little longer for a primary key
             flavor = "tap-preferred";
             bindings = <&kp Q>, <&kp ESC>;
         };
         #+end_src
       - 2. In `config/wrappers.dtsi`, update the `___BASE_L1___` macro to use the new behavior instead of `&td_q_esc`:
         #+begin_src c
         #define ___BASE_L1___ &q_esc_ht ...
         #+end_src
   - [ ] **Smart Key Repeat:** Add key repeat to home-row mods. This allows a letter to repeat on a double-tap-and-hold, which is not possible with a standard hold-tap.
     - Add this behavior to `config/behaviors.dtsi`:
       #+begin_src dts
       hml_rep: homerow_mods_left_with_repeat {
           compatible = "zmk,behavior-hold-tap";
           label = "HML_REPEAT";
           #binding-cells = <2>;
           tapping-term-ms = <200>;
           flavor = "balanced";
           bindings = <&kp>, <&kp>;
           hold-bindings = <&kp>, <&key_repeat>;
       };
       #+end_src
     - Update home-row mod macros in `config/wrappers.dtsi` to use the new behavior (e.g., `&hml_rep`).

** [ ] Configure Sofle Hardware
   - [ ] **Add status widgets to OLED:** The `sofle.conf` file currently enables the display but is missing the required flags for useful widgets. Add the following flags to enable them:
     - `CONFIG_ZMK_WIDGET_BATTERY_STATUS=y`
     - `CONFIG_ZMK_WIDGET_BATTERY_STATUS_SHOW_PERCENTAGE=y`
     - `CONFIG_ZMK_WIDGET_OUTPUT_STATUS=y`
     - `CONFIG_ZMK_WIDGET_LAYER_STATUS=y`
   - [ ] **Add WPM widget to OLED:**
     - Add `CONFIG_ZMK_WPM=y` and `CONFIG_ZMK_WIDGET_WPM_STATUS=y` to `sofle.conf`.
   - [ ] Add RGB underglow support to indicate the current layer.

** [ ] Integrate external modules
   - [ ] **`zmk-tri-state`:**
     - [ ] Add the module to `west.yml`.
     - [ ] Implement a one-handed Alt-Tab "swapper" (Swapper).
     - [ ] Use it to create the `ADJUST` tri-layer.
   - [ ] **`zmk-antecedent-morph`:**
     - [ ] Find and add `urob`'s module to `west.yml`.
     - [ ] Implement adaptive behaviors for common programming ligatures like `=>`, `!=`, `->`.

** [ ] Explore advanced ZMK behaviors (QMK Equivalents)
    - [ ] **`CAPS WORD`:** Add `CONFIG_ZMK_CAPS_WORD=y` and a keybinding for it.
    - [ ] **Dynamic Macros:** Investigate and enable `CONFIG_ZMK_MACRO_DYNAMIC=y` for on-the-fly macro recording.
    - [ ] **Speculative Hold:** Use the `hold-while-undecided` property in hold-tap behaviors to reduce modifier lag.
    - [ ] **Permissive Hold:** Use the `"balanced"` flavor for hold-tap behaviors for a more responsive feel for fast typists.
    - [ ] **Per-key Tapping Term:** Use the `tapping-term-ms` property on specific hold-tap bindings that need a custom value.
    - [ ] **Numword (Smart Layers):** Implement behavior where the layer stays active only while typing numbers, deactivating on space/letter.
    - [ ] **Mod-Morphs (Contextual Keys):** Expand usage beyond `bs_del`, e.g., smart dot ('.', '..', '/'), grave escape ('Esc' to '`' when GUI is held).

** [ ] Configure BIOS/Bootloader Compatibility (NKRO)
   - [ ] NOTE: ZMK defaults to 6KRO, which is safe for BIOS. Enabling NKRO (`CONFIG_ZMK_HID_REPORT_TYPE_NKRO=y`) improves OS performance but may break BIOS compatibility.
   - [ ] NOTE: Unlike QMK, there is no runtime keybinding to toggle between 6KRO and NKRO. The mode is set at compile time. QMK's `NK_TOGG` keycode is not directly portable.
   - [ ] DECISION: Decide whether to enable NKRO by default and test for BIOS compatibility.
   - [ ] ACTION: Add `CONFIG_ZMK_HID_REPORT_TYPE_NKRO=y` to the `.conf` files if NKRO is desired.

** [ ] Merge `wrappertest` branch

** [ ] ZMK Studio Integration
   - [ ] Add the ZMK Studio snippet to `build_all.sh`.
   - [ ] Configure a `&studio_unlock` key in the keymap for real-time keymap changes.

* Code Snippets

** 1. Flexible Encoder Behavior (`sensor_rot_kp` migration):**

   **Goal:** Migrate from `&inc_dec_kp` to a more flexible behavior (`sensor_rot_kp`) that allows binding any ZMK behavior to encoder rotations, and easily customize per layer.

   **Implementation Details:**

   - **`config/behaviors.dtsi` (Define the new behavior):**
     #+begin_src dts
     encoder_macro_actions: encoder_macro_actions { // Or use the name sensor_rot_kp from previous steps
         compatible = "zmk,behavior-sensor-custom";
         #binding-cells = <2>; // Takes 2 args: CW_action, CCW_action
         bindings-clockwise = <__VA_ARGS_BINDING_CELL_1__>;
         bindings-counter-clockwise = <__VA_ARGS_BINDING_CELL_2__>;
     };
     #+end_src

   - **`config/wrappers.dtsi` (Update wrapper macros to use `sensor_rot_kp`):**
     Replace all instances of `&inc_dec_kp CW_KEY CCW_KEY` with `&sensor_rot_kp CW_KEY CCW_KEY`.
     #+begin_src dts
     // Example for ___ENC_BASE___
     #define ___ENC_BASE___         &sensor_rot_kp kp C_VOL_UP kp C_VOL_DN \
                                    &sensor_rot_kp kp PG_UP kp PG_DN
     #end_src

   - **Layer-Specific Overrides (Example in `sofle.keymap` or `cradio.keymap`):**
     To change encoder behavior for a specific layer, override its `sensor-bindings`.
     #+begin_src dts
     raise {
         // ... other key bindings ...

         sensor-bindings = <
             // First encoder: Screen Brightness
             &sensor_rot_kp kp C_BRI_UP kp C_BRI_DN
             // Second encoder: RGB Underglow Hue
             &sensor_rot_kp rgb_ug RGB_HUI rgb_ug RGB_HUD
         >;
     };
     #end_src

** 2. Common Encoder Uses for Other Layers:**

   Here are some popular and highly useful ideas for encoder applications on different layers, leveraging the flexibility of `sensor_rot_kp`:

   - **Media & Volume Control (Your Current Default):**
     - Base/Default Layer: `&kp C_VOL_UP / &kp C_VOL_DN` (Volume control)
     - Base/Default Layer: `&kp PG_UP / &kp PG_DN` (Page Up/Down)

   - **Scrolling (More Granular Control):**
     - Navigation Layer (e.g., `FUNC` layer):
       - `&kp UP / &kp DOWN` for fine-grained vertical scrolling.
       - `&kp LEFT / &kp RIGHT` for horizontal scrolling (e.g., in spreadsheets or timelines).
     - Fast Scroll: Combine with a modifier: `&kp LSHIFT LEFT / &kp LSHIFT RIGHT`

   - **Layer Switching / Navigation:**
     - Adjust Layer / Utility Layer:
       - Workspace/Desktop Switching: `&kp LG(LEFT) / &kp LG(RIGHT)` (macOS) or `&kp LCTRL LALT LEFT / &kp LCTRL LALT RIGHT` (Linux/Windows).
       - Tab Switching: `&kp LCTRL TAB / &kp LCTRL LS(TAB)` (in browsers/apps).
       - Layer Cycling: `&tog Layer_N / &tog Layer_M` to cycle between specific layers.

   - **Brightness / Backlight Control:**
     - Adjust Layer / Utility Layer:
       - Screen Brightness: `&kp C_BRI_UP / &kp C_BRI_DN`
       - RGB Underglow Brightness: `&rgb_ug RGB_BRI / &rgb_ug RGB_BRD` (if RGB underglow is enabled)
       - RGB Underglow Hue/Saturation: `&rgb_ug RGB_HUI / &rgb_ug RGB_HUD` or `&rgb_ug RGB_SAI / &rgb_ug RGB_SAD`

   - **Application-Specific Controls (Power User!):**
     - Video Editing / Audio Production Layer:
       - `&macro_timeline_zoom_in / &macro_timeline_zoom_out`
       - `&macro_track_prev / &macro_track_next`
     - Graphics Editing Layer (e.g., Photoshop):
       - `&macro_brush_size_up / &macro_brush_size_down`
       - `&macro_zoom_in / &macro_zoom_out`
     - IDE/Editor Specific:
       - `&macro_next_error / &macro_prev_error`
       - `&macro_line_indent / &macro_line_dedent`
